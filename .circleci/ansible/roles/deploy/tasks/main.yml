---
- name: "update local apt repo."
  become: true
  apt:
    update_cache: yes

- name: "upgrade apt packages"
  become: true
  apt:
    upgrade: yes

- name: "remove stale dependencies"
  become: true
  apt:
    autoremove: yes

- name: "install dependencies [nodejs and npm]."
  become: true
  apt:
    name: ["nodejs", "npm"]
    state: latest
    update_cache: yes

- name: "install pm2"
  become: true
  npm:
    name: pm2
    global: yes
    production: yes
    state: present

- name: "Copy artifact into Instance" 
  become: true
  copy:
    src: ~/project/artifact.tar.gz
    dest: /home/ubuntu/artifact.tar.gz


- name: "Start app"
  become: true
  shell: |
    cd /home/ubuntu
    tar xzvf artifact.tar.gz
    npm install
    # npm run build
    pm2 stop default
    pm2 start npm -- start


# ---
#   - name: Update
#     become: yes
#     apt:
#       update_cache: yes
#       cache_valid_time: 86400
#   - name: remove unneeded deps
#     become: yes
#     apt:
#       autoremove: yes

#   - name: "upgrade packages"
#     become: yes
#     apt: 
#       upgrade: yes

#   - name: install dependencies
#     becomes: yes
#     apt:
#       name: ['nodejs', 'npm']
#       state: latest
#       update_cache: yes

#   - name: install pm2
#     becomes: yes
#     apt:
#       name: pm2
#       global: yes
#       state: latest
#       production: yes 

#   - name: Unarchive files
#     becomes: yes
#     unarchive:
#       src: files/artifact.tar.gz
#       dest: .

#   # - name: extract artifact
#   #   become: yes
#   #   unarchive:
#   #     src: "files/artifact.tar.gz"
#   #     dest: .

#   - name: start application
#     become: yes
#     shell: |
#       npm install
#       pm2 stop default
#       # pm2 delete all
#       pm2 start npm -- start